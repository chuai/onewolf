<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="ys_Jmstj_SqlMap" >


<!-- 查询加盟商列表 -->
 <select id="queryList" parameterClass="java.util.HashMap"
		resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
			<!-- select 
			yj.tjdate,
			yj.jmsid,
			ssc.`name` as jmsname,
			ssc.empowerNum,
			sum(yj.amount) as amount,
			sum(yj.maintenance) as maintenance,
			sum(yj.accountfees) as accountfees,
			sum(yj.traffic) as traffic,
			sum(yj.ratemargin) as ratemargin,
			sum(yj.qtcpfy) as qtcpfy,
			sum(yj.fx) as fx,
			yj.jsbl,
			yj.`status`,
			yj.tjdate
			from ys_jmstj yj
			left join sys_company ssc on yj.jmsid = ssc.id
			where 1=1 and yj.`status`=1 -->
			
			       select   
				   yj.id,
				   yj.jmsid,
				   yj.amount,
				   yj.maintenance,
				   yj.accountfees,
				   yj.traffic,
				   yj.qtcpfy,
				   yj.ratemargin,
				   yj.qtfwf,
				   yj.fx,
				   yj.hblcfr,
				   yj.hbglffr,
				   yj.hbsyhj,
				   ssc.`name` as jmsname,
				   ssc.empowerNum,
				   ym.username,
				   yj.hbuid,
				   yj.`status`,
				   yj.jsbl,
				   yj.tjdate
				from ys_jmstj yj
				left join sys_company ssc on yj.jmsid = ssc.id
				left join ys_member ym on yj.hbuid = ym.uid
		<dynamic prepend="where">
		  <isNotEmpty prepend="and " property="empowerNum"> ssc.empowerNum= #empowerNum#</isNotEmpty>
		  <isNotEmpty prepend="and " property="jmsname"> ssc.`name`= #jmsname#</isNotEmpty>
		  <isNotEmpty prepend="and " property="status">yj.status= #status#</isNotEmpty>
		  <isNotEmpty prepend="and " property="accountfeesStauts">yj.accountfeesStauts= #accountfeesStauts#</isNotEmpty>
		  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="timetoo">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') <= #timetoo#]]>  
    	  </isNotEmpty>
		</dynamic>
		 ORDER BY yj.tjdate
     </select>

	<!--  查询加盟商未计算统计报表 -->
  <select id="queryCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		 <!--  select count(*) FROM (select 
		yj.tjdate,
		yj.jmsid,
		ssc.`name` as jmsname,
		ssc.empowerNum,
		sum(yj.amount) as amount,
		sum(yj.maintenance) as maintenance,
		sum(yj.accountfees) as accountfees,
		sum(yj.traffic) as traffic,
		sum(yj.ratemargin) as ratemargin,
		sum(yj.qtcpfy) as qtcpfy,
		sum(yj.fx) as fx,
		yj.`status`
		from ys_jmstj yj
		left join sys_company ssc on yj.jmsid = ssc.id
		group by tjdate,jmsid ORDER BY tjdate) jms
		where 1=1 and jms.`status`=1 -->
		
		
				select   
				  count(*)
				from ys_jmstj yj
				left join sys_company ssc on yj.jmsid = ssc.id
				left join ys_member ym on yj.hbuid = ym.uid
	   	<dynamic prepend="where">
		 <isNotEmpty prepend="and " property="empowerNum"> ssc.empowerNum= #empowerNum#</isNotEmpty>
		  <isNotEmpty prepend="and " property="jmsname"> ssc.`name`= #jmsname#</isNotEmpty>
		  <isNotEmpty prepend="and " property="status">yj.status= #status#</isNotEmpty>
		  <isNotEmpty prepend="and " property="accountfeesStauts">yj.accountfeesStauts= #accountfeesStauts#</isNotEmpty>
		  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="timetoo">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') <= #timetoo#]]>  
    	  </isNotEmpty>
		</dynamic>
  </select>
  
  
<!-- 查询加盟商未计算统计报表-->
 <select id="querywjsList" parameterClass="java.util.HashMap"
		resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
			<!-- select 
			yj.tjdate,
			yj.jmsid,
			ssc.`name` as jmsname,
			ssc.empowerNum,
			sum(yj.amount) as amount,
			sum(yj.maintenance) as maintenance,
			sum(yj.accountfees) as accountfees,
			sum(yj.traffic) as traffic,
			sum(yj.ratemargin) as ratemargin,
			sum(yj.qtcpfy) as qtcpfy,
			sum(yj.fx) as fx,
            ymb.banknum,
			yj.jsbl,
			yj.`status`
			from ys_jmstj yj
			left join sys_company ssc on yj.jmsid = ssc.id
      left join ys_member_bank ymb on ymb.uid = yj.hbuid
			where 1=1 and yj.`status`=0 and ymb.isCheck = 1 -->
			
			
				 select   
				   yj.id,
				   yj.jmsid,
				   yj.amount,
				   yj.maintenance,
				   yj.accountfees,
				   yj.traffic,
				   yj.qtcpfy,
				   yj.ratemargin,
				   yj.qtfwf,
				   yj.fx,
				   yj.hblcfr,
				   yj.hbglffr,
				   yj.hbsyhj,
				   ssc.`name` as jmsname,
				   ssc.empowerNum,
				   yj.hbuid,
				   yj.`status`,
				   yj.jsbl,
				   ym.username,
				   yj.tjdate
				from ys_jmstj yj
				left join sys_company ssc on yj.jmsid = ssc.id
				left join ys_member ym on yj.hbuid = ym.uid
		<dynamic prepend="where">
		  <isNotEmpty prepend="and " property="empowerNum"> ssc.empowerNum= #empowerNum#</isNotEmpty>
		  <isNotEmpty prepend="and " property="jmsname"> ssc.`name`= #jmsname#</isNotEmpty>
		  <isNotEmpty prepend="and " property="status">yj.status= #status#</isNotEmpty>
		  <isNotEmpty prepend="and " property="accountfeesStauts">yj.accountfeesStauts= #accountfeesStauts#</isNotEmpty>
		  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="timetoo">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') <= #timetoo#]]>  
    	  </isNotEmpty>
		</dynamic>
		 ORDER BY yj.tjdate
     </select>
     
     
     

	<!--  查询加盟商未计算统计报表 -->
  <select id="querywjsCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		 <!-- select COUNT(*) from (
			select 
			yj.tjdate,
			yj.jmsid,
			ssc.`name` as jmsname,
			ssc.empowerNum,
			sum(yj.amount) as amount,
			sum(yj.maintenance) as maintenance,
			sum(yj.accountfees) as accountfees,
			sum(yj.traffic) as traffic,
			sum(yj.ratemargin) as ratemargin,
			sum(yj.qtcpfy) as qtcpfy,
			sum(yj.fx) as fx,
      		ymb.banknum,
			yj.jsbl,
			yj.`status`
			from ys_jmstj yj
			left join sys_company ssc on yj.jmsid = ssc.id
      		left join ys_member_bank ymb on ymb.uid = yj.hbuid
			where 1=1 and yj.`status`=0 and ymb.isCheck = 1
     		group by yj.tjdate,yj.jmsid ORDER BY yj.tjdate) jms 
     		where 1=1 -->
     		
     		select   
				  count(*)
				from ys_jmstj yj
				left join sys_company ssc on yj.jmsid = ssc.id
				left join ys_member ym on yj.hbuid = ym.uid
	   	<dynamic prepend="where">
		 <isNotEmpty prepend="and " property="empowerNum"> ssc.empowerNum= #empowerNum#</isNotEmpty>
		  <isNotEmpty prepend="and " property="jmsname"> ssc.`name`= #jmsname#</isNotEmpty>
		  <isNotEmpty prepend="and " property="status">yj.status= #status#</isNotEmpty>
		  <isNotEmpty prepend="and " property="accountfeesStauts">yj.accountfeesStauts= #accountfeesStauts#</isNotEmpty>
		  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="timetoo">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') <= #timetoo#]]>  
    	  </isNotEmpty>
		</dynamic>
  </select>
  
  
  <!-- 查询加盟商已计算项目统计报表-->
 <select id="tojmsyjsxmtjList" parameterClass="java.util.HashMap"
		resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
		
			select yj.*,ssc.empowerNum,ssc.`name` as jmsname from ys_jmstj yj
			left join sys_company ssc on yj.jmsid = ssc.id 
			where 1=1 and yj.`status` = 1  
			 
		<dynamic prepend="">
		  <isNotEmpty prepend="and " property="empowerNum"> ssc.empowerNum= #empowerNum#</isNotEmpty>
		  <isNotEmpty prepend="and " property="jmsname"> ssc.`name`= #jmsname#</isNotEmpty>
		  <isNotEmpty prepend="and " property="status">yj.status= #status#</isNotEmpty>
		  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="timetoo">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') <= #timetoo#]]>  
    	  </isNotEmpty>
		</dynamic>
		order by  yj.tjdate
     </select>

	<!-- 查询加盟商已计算项目统计报表 -->
  <select id="tojmsyjsxmtjcount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
  
		 select count(*) from ys_jmstj yj
			left join sys_company ssc on yj.jmsid = ssc.id 
			where 1=1 and yj.`status` = 1 
		 
	   	<dynamic prepend="">
		 <isNotEmpty prepend="and " property="empowerNum"> ssc.empowerNum= #empowerNum#</isNotEmpty>
		  <isNotEmpty prepend="and " property="jmsname"> ssc.`name`= #jmsname#</isNotEmpty>
		  <isNotEmpty prepend="and " property="status">yj.status= #status#</isNotEmpty>
		  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="timetoo">   
          		<![CDATA[DATE_FORMAT(yj.tjdate,'%Y-%m-%d') <= #timetoo#]]>  
    	  </isNotEmpty>
    	   order by  yj.tjdate  
		</dynamic>
  </select>
  
  
  <!-- 批量更新记录 -->
  <update id="updateAll" parameterClass="java.util.HashMap" >
    update ys_jmstj
    <dynamic prepend="set">
      <isNotNull prepend="," property="status">
        status = #status:INTEGER#
      </isNotNull>
       <isNotNull prepend="," property="endtime">
        endtime = #endtime#
      </isNotNull>
      <isNotNull prepend="," property="endaccounttime">
        endaccounttime = #endaccounttime#
      </isNotNull>
      <isNotNull prepend="," property="accountfeesStauts">
        accountfeesStauts = #accountfeesStauts:INTEGER#
      </isNotNull>
    </dynamic> 
    where 1=1 
	<dynamic prepend="">
		<isNotEmpty prepend="and"  property="ids" > 
				id =#ids:INTEGER#
		</isNotEmpty>
	</dynamic> 
  </update>
  
  
   <select id="selectYsJmstjhj" parameterClass="java.util.HashMap"
		resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
			select 
			if(sum(amount) is null,0,sum(amount)) as amount,
			if(sum(hbglffr) is null,0,sum(hbglffr)) as hbglffr,
			if(sum(hblcfr) is null,0,sum(hblcfr)) as hblcfr,
			if(sum(qtfwf+traffic) is null,0,sum(qtfwf+traffic)) as qtfwf,
			if(sum(fx) is null,0,sum(fx)) as fx,
			if(sum(hbsyhj) is null,0,sum(hbsyhj)) as hbsyhj
			from ys_jmstj
				
		<dynamic prepend="where">
		  <isNotEmpty prepend="and " property="status">status= #status#</isNotEmpty>
		</dynamic>
     </select>
     
     
      <select id="getJmstjByJmsID" parameterClass="java.util.HashMap"
		resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
			<!-- select  * from ys_jmstj -->
			select  
				id,
			  empowerNum,
			  jmsid,
			  amount,
			  maintenance,
			  accountfees,
			  traffic,
			  qtcpfy,
			  ratemargin,
			  qtfwf,
			  sum(qtfwf+traffic) as qtfwf1,
			  fx,
			  jsbl,
			  hblcfr,
			  hbglffr,
			  hbsyhj,
			  hbuid,
			 accountfeesStauts,
			 status,
			  tjdate from ys_jmstj
		<dynamic prepend="where">
		  <isNotEmpty prepend="and " property="id">id= #id#</isNotEmpty>
		</dynamic>
     </select>
     
     
     <select id="getJmstjByJmsIDs" parameterClass="java.util.HashMap"
		resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
			select SUM(amount) as amount,SUM(maintenance) as maintenance,
			sum(accountfees) as accountfees,
			sum(traffic) as traffic,
			sum(qtcpfy) as qtcpfy,
			sum(ratemargin) as ratemargin,
			sum(qtfwf+traffic) as qtfwf,
			sum(fx) as fx,
			sum(hblcfr) as hblcfr,
			sum(hbglffr) as hbglffr,
			sum(hbsyhj) as hbsyhj
			from ys_jmstj 
		<dynamic prepend="where">
		  <isNotEmpty prepend="and " property="id">id= #id#</isNotEmpty>
		  <isNotEmpty prepend="and"  property="ids" > 
				id in				
				<iterate property="ids" open="(" close=")" conjunction=","> 
   					 #ids[]#
     			</iterate>
		</isNotEmpty>
		</dynamic>
     </select>
     
     
     
     <!-- 查询加盟商企业法人账户余额 -->
      <select id="getYsMemberFundsByUid" parameterClass="java.util.HashMap"
		resultClass="java.math.BigDecimal">
			select balance from ys_member_funds 
		<dynamic prepend="where">
		  <isNotEmpty prepend="and " property="uid">uid= #uid#</isNotEmpty>
		</dynamic>
     </select>
     
     
      <!-- 查询公司各个账户余额 -->
      <select id="getCompanyFundsByid" parameterClass="java.util.HashMap"
		resultClass="java.math.BigDecimal">
			
		select amount from ys_company_funds 
		
		<dynamic prepend="where">
		  <isNotEmpty prepend="and " property="id">id= #id#</isNotEmpty>
		</dynamic>
     </select>
  
  
  
   <update id="updatecompanyFunds" parameterClass="com.yinshu.component.system.ysloan.entity.model.YsCompanyFunds" >
    update ys_company_funds
    <dynamic prepend="set" >
      <isNotNull prepend="," property="amount" >
        amount = #amount#
      </isNotNull>
    </dynamic>
    where id = #id:INTEGER#
  </update>
  
  
  <update id="updatememberFunds" parameterClass="com.yinshu.component.system.finance.entity.model.YsMemberFunds" >
    update ys_member_funds
    <dynamic prepend="set" >
      <isNotNull prepend="," property="balance" >
        balance = #balance#
      </isNotNull>
    </dynamic>
    where uid = #uid:INTEGER#
  </update>
  
  <!--查询加盟商借款业绩明细 -->
	<select id="getListLoanByJmsID" parameterClass="java.util.HashMap" resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
		  select yl.lid,
		         yl.amount,
		         yl.audittime,
		         yl.lcoding,
		         yl.deadline,
		         ssc.id as jmsid ,
                 ssc.ownerUid,
                 ssc.`name` as jmsname,
                 ssc.empowerNum
			from ys_loan yl
			left join ys_loan_class ylc on yl.lid = ylc.lid
			left join sys_company ssc on ylc.companyId = ssc.id
	     where  yl.status='4'  
		<dynamic prepend=" and ">
			<isNotEmpty prepend=" and" property="jmsid"> ssc.id=#jmsid#</isNotEmpty>
			<isNotEmpty prepend=" and" property="status"> yl.status=#status#</isNotEmpty>
			<isNotEmpty prepend=" and" property="lcoding"> yl.lcoding=#lcoding#</isNotEmpty>
			<isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yl.audittime,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yl.audittime,'%Y-%m-%d') <= #time#]]>  
    	  </isNotEmpty>
		</dynamic>
	</select>
  <!--查询加盟商借款管理费明细 -->
	<select id="ListLoanmaintenanceMX" parameterClass="java.util.HashMap" resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
		 select
		  yl.lid,
		  if(dkglf1.amount is null,0,dkglf1.amount) as amount,
		  yl.audittime,
		  yl.lcoding,
		  ssc.id as jmsid ,
		  ssc.jsbl,
      	 ssc.ownerUid,
      	 ssc.`name` as jmsname,
      	 ssc.empowerNum
			from ys_loan yl
			left join ys_loan_class ylc on yl.lid = ylc.lid
			left join sys_company ssc on ylc.companyId = ssc.id
			left join
		(select lid, amount  from ys_member_funds_log where varytype='17' and type='0' 
		<dynamic prepend="and">
			<isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') <= #time#]]>  
    	  </isNotEmpty>
		</dynamic>

  		) dkglf1 on yl.lid = dkglf1.lid
	   where 1=1  and yl.status='4' 
		<dynamic prepend=" and ">
			<isNotEmpty prepend=" and" property="jmsid"> ssc.id=#jmsid#</isNotEmpty>
			<isNotEmpty prepend=" and" property="status"> yl.status=#status#</isNotEmpty>
		</dynamic>
	</select>
  <!--查询加盟商利差细 -->
	<select id="ListlcMX" parameterClass="java.util.HashMap" resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
		<!--  select
		  yl.lid,
		  if(lc.amount is null,0,lc.amount) as amount,
		  yl.audittime,
		  yl.lcoding,
		  ssc.id as jmsid ,
		  ssc.jsbl,
      	 ssc.ownerUid,
      	 ssc.`name` as jmsname,
      	 ssc.empowerNum
			from ys_loan yl
			left join ys_loan_class ylc on yl.lid = ylc.lid
			left join sys_company ssc on ylc.companyId = ssc.id
			left join
		(select lid, amount  from ys_company_funds_log where varytype='32' and type='1' 
		<dynamic prepend="and">
			<isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') <= #time#]]>  
    	  </isNotEmpty>
		</dynamic>

  		) lc on yl.lid = lc.lid
	   where 1=1  and yl.status='4'  -->
	   
	   
	   select yl.lid,SUM(marginlx)  as amount ,yl.audittime,yl.lcoding,
		  ssc.id as jmsid ,ssc.jsbl,
      ssc.ownerUid,ssc.`name` as jmsname,ssc.empowerNum
			from ys_loan yl
			left join ys_loan_class ylc on yl.lid = ylc.lid
			left join sys_company ssc on ylc.companyId = ssc.id
			left join ys_loan_repayment ylr on yl.lid = ylr.lid
     where yl.status='4' and ylr.status in (1,2,4,5,6)
		<dynamic prepend=" and ">
			<isNotEmpty prepend=" and" property="jmsid"> ssc.id=#jmsid#</isNotEmpty>
			<isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(ylr.facttime,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(ylr.facttime,'%Y-%m-%d') <= #time#]]>  
    	  </isNotEmpty>
		</dynamic>
		group by ylr.lid;
	</select>
	
  <!--查询加盟商其他服务费明细 -->
	<select id="ListqtfwfMX" parameterClass="java.util.HashMap" resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
		<!-- select lid,
		       amount,
		       cpfy,
		       llf,
		       audittime,
		       lcoding,
		       deadline,
		       jmsid,
		       owneruid,
		       jmsname,
		       empowerNum ,
		       sum(cpfy+llf) as qtfwf
		        from (
					select yl.lid,yl.amount,if(p.cpfy is null,0,p.cpfy) as cpfy,
						if(llf.amount is null,0,llf.amount) as llf,
						yl.audittime,yl.lcoding,yl.deadline,
		  				ssc.id as jmsid ,
      					ssc.ownerUid,ssc.`name` as jmsname,ssc.empowerNum
					from ys_loan yl
					left join ys_loan_class ylc on yl.lid = ylc.lid
					left join sys_company ssc on ylc.companyId = ssc.id
					left join(select pid, if(sum(ypc.value) is null,0,sum(ypc.value)) as cpfy from ys_product_charge ypc where ypc.chargename !='服务费' group by ypc.pid) p on p.pid = yl.pid
      				left join(select lid, amount  from ys_member_funds_log where varytype='46' and type='0' 
      				<dynamic prepend="and">
						<isNotEmpty prepend="AND" property="time">   
			          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') >= #time#]]>  
			    	  </isNotEmpty>
			    	  <isNotEmpty prepend="AND" property="time">   
			          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') <= #time#]]>  
			    	  </isNotEmpty>
					</dynamic>
      				)llf on llf.lid = yl.lid
	   				where  yl.status='4'  -->
	   				
	   				
	   				select lid,lcoding,jmsid,ownerUid,jmsname,empowerNum,cpfy,fwf,llf from (
					select 
					  yl.lid,
						yl.lcoding,
						yl.deadline,
						ssc.id AS jmsid,
						ssc.ownerUid,
						ssc.`name` AS jmsname,
						ssc.empowerNum,
					 if(cpfy.amount is null,0,cpfy.amount) as cpfy,
						if(fwf.amount is null,0,fwf.amount) as fwf,
					  if(llf.amount is null,0,llf.amount)as llf
					FROM
						ys_loan yl
				LEFT JOIN ys_loan_class ylc ON yl.lid = ylc.lid
				LEFT JOIN sys_company ssc ON ylc.companyId = ssc.id
				LEFT JOIN(select lid, if(sum(amount) is null,0,sum(amount)) as amount  from ys_member_funds_log where varytype='30' and type='0' 
				<dynamic prepend=" and ">
					<isNotEmpty prepend="AND" property="time">   
			          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') >= #time#]]>  
			    	  </isNotEmpty>
			    	  <isNotEmpty prepend="AND" property="time">   
			          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') <= #time#]]>  
			    	  </isNotEmpty> 
				</dynamic> 
				 
				  group by lid )cpfy ON cpfy.lid = yl.lid
				left join (select lid,if(sum(amount) is null,0,sum(amount)) as amount from ys_member_funds_log where remark  like '%”服务费“'  and varytype='30' and type='0'  
				<dynamic prepend=" and ">
					<isNotEmpty prepend="AND" property="time">   
			          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') >= #time#]]>  
			    	  </isNotEmpty>
			    	  <isNotEmpty prepend="AND" property="time">   
			          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') <= #time#]]>  
			    	  </isNotEmpty> 
				</dynamic> 
		group by lid) fwf on yl.lid = fwf.lid
				LEFT JOIN(SELECT lid,amount FROM ys_member_funds_log WHERE varytype = '46' AND type = '0' 
				<dynamic prepend=" and ">
					<isNotEmpty prepend="AND" property="time">   
			          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') >= #time#]]>  
			    	  </isNotEmpty>
			    	  <isNotEmpty prepend="AND" property="time">   
			          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') <= #time#]]>  
			    	  </isNotEmpty> 
				</dynamic> 
				)llf ON llf.lid = yl.lid
				WHERE
					yl. STATUS = '4'
			<dynamic prepend=" and ">
					<isNotEmpty prepend=" and" property="jmsid"> ssc.id=#jmsid#</isNotEmpty>
				</dynamic>
				group by yl.lid
				) qtfwfmx
	</select>
	
	
	  <!--查询加盟商罚息明细 -->
	<select id="ListfxMX" parameterClass="java.util.HashMap" resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
		 select
		  yl.lid,
		  if(lc.amount is null,0,lc.amount) as amount,
		  yl.audittime,
		  yl.lcoding,
		  ssc.id as jmsid ,
		  ssc.jsbl,
      	 ssc.ownerUid,
      	 ssc.`name` as jmsname,
      	 ssc.empowerNum
			from ys_loan yl
			left join ys_loan_class ylc on yl.lid = ylc.lid
			left join sys_company ssc on ylc.companyId = ssc.id
			left join
		(select lid, amount  from ys_member_funds_log where varytype='34' and type='0' 
		<dynamic prepend="and">
			<isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') <= #time#]]>  
    	  </isNotEmpty>
		</dynamic>

  		) lc on yl.lid = lc.lid
	   where 1=1  and yl.status='4' 
		<dynamic prepend=" and ">
			<isNotEmpty prepend=" and" property="jmsid"> ssc.id=#jmsid#</isNotEmpty>
			<isNotEmpty prepend=" and" property="status"> yl.status=#status#</isNotEmpty>
			<!-- <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yl.audittime,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(yl.audittime,'%Y-%m-%d') <= #time#]]>  
    	  </isNotEmpty> -->
		</dynamic>
	</select>
	
	  <!--查询加盟商账户管理费明细 -->
	<select id="ListzhglfMX" parameterClass="java.util.HashMap" resultClass="com.yinshu.component.system.substation.entity.model.YsJmstj">
		<!--  select
		  yl.lid,
		  if(lc.amount is null,0,lc.amount) as amount,
		  yl.audittime,
		  yl.lcoding,
		  ssc.id as jmsid ,
		  ssc.jsbl,
      	 ssc.ownerUid,
      	 ssc.`name` as jmsname,
      	 ssc.empowerNum
			from ys_loan yl
			left join ys_loan_class ylc on yl.lid = ylc.lid
			left join sys_company ssc on ylc.companyId = ssc.id
			left join
		(select lid, amount  from ys_member_funds_log where varytype='18' and type='0' 
		<dynamic prepend="and">
			<isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(addtime,'%Y-%m-%d') <= #time#]]>  
    	  </isNotEmpty>
		</dynamic>

  		) lc on yl.lid = lc.lid
	   where 1=1  and yl.status='4'  -->
	   SELECT 	ymfl.lid,
					if(sum(ymfl.amount) is null,0,sum(ymfl.amount)) as amount,
					ymfl.addtime,
					yl.audittime,
					yl.lcoding,
					ssc.id AS jmsid,
					ssc.jsbl,
					ssc.ownerUid,
					ssc.`name` AS jmsname,
					ssc.empowerNum
					FROM ys_member_funds_log ymfl
					left join ys_loan yl on ymfl.lid = yl.lid
					LEFT JOIN ys_loan_class ylc ON yl.lid = ylc.lid
					LEFT JOIN sys_company ssc ON ylc.companyId = ssc.id
 					WHERE ymfl.varytype = '18' 
 					AND ymfl.type = '0'  and yl.repaymentstatus='1'
 					
		<dynamic prepend=" and ">
			<isNotEmpty prepend=" and" property="jmsid"> ssc.id=#jmsid#</isNotEmpty>
			<isNotEmpty prepend=" and" property="status"> yl.status=#status#</isNotEmpty>
			<isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(ymfl.addtime,'%Y-%m-%d') >= #time#]]>  
    	  </isNotEmpty>
    	  <isNotEmpty prepend="AND" property="time">   
          		<![CDATA[DATE_FORMAT(ymfl.addtime,'%Y-%m-%d') <= #time#]]>  
    	  </isNotEmpty>
		</dynamic>
		GROUP BY 	ymfl.lid
	</select>
	
	
  
</sqlMap>